#!/usr/bin/env python3

from os.path import expanduser
import frontmatter
import os
import glob
import dateutil.parser
import datetime
import re
import config
import shutil

home = expanduser("~")

sermons_path = (home + '/Sites/fbcmuncie_2018/_posts/2020*.md')
sermon_posts = glob.glob(sermons_path)
vimeo_pic_path = (home + '/Sites/fbcmuncie_2018/images/vimeo/*.jpg')
vimeo_pics = glob.glob(vimeo_pic_path)
blog_path = (home + '/Sites/fbcmuncie_2018/_posts/*.markdown')
blog_posts = glob.glob(blog_path)
sermon_image_path = (home + '/Sites/fbcmuncie_2018/images/sermon/*.jpg')
sermon_images = glob.glob(sermon_image_path)
worship_path = (home + '/Sites/fbcmuncie_2018/_worship/*.md')
worship_posts = glob.glob(worship_path)

# Function to check key 
def field(key):
	if key in post:
		return post[key]

for name in sermon_posts:
	post = frontmatter.load(name)
	title = field('title')
	vimeo = field('vimeo')
	youtube = field('youtube')
	scripture =	field('scripture')
	speaker = field('author')
	duration = field('duration')
	length = field('length')
	description = post.content
	if 'date' in post:
		if type(post['date']) is datetime.date:
			date = post['date'].strftime('%Y-%m-%d')
		else:
			date = dateutil.parser.parse(post['date']).strftime('%Y-%m-%d')
	title_sliced = title.split()
	slug = ("-".join(title_sliced).lower())
	slug = slug.replace("?", "")
	slug = slug.replace("'", "")
	slug = slug.replace(":", "")
	slug = re.sub("[\(\[].*?[\)\]]", "", slug)
	filename =(home + '/Sites/hugo_fbcmuncie/content/video/' + date + '-' + slug + '.md')
	filename = filename.replace("-.", ".")
	filename = filename.replace("--", "-")
	filename = filename.replace(":", "-")
	target = open (filename, 'w')
	target.write('---\n')
	target.write(f'author: "{speaker}"\n')
	target.write(f'title: "{title}"\n')
	target.write(f'scripture: "{scripture}"\n')
	target.write(f'date: {date}\n')
	target.write(f'duration: {duration}\n')
	target.write(f'length: {length}\n')
	target.write(f'vimeo: {vimeo}\n')
	target.write(f'youtube: {youtube}\n')
	target.write('---\n')
	target.write('\n')
	target.write(description)
	target.write("\n")
	target.close()

# copy images over from old site to new
for image in vimeo_pics:
	copy_path = (home + '/Sites/hugo_fbcmuncie/static/images/vimeo/')
	base = os.path.basename(image)
	shutil.copyfile(image, copy_path + base)

# copy sermon images to new site
for image in sermon_images:
	copy_path = (home + '/Sites/hugo_fbcmuncie/static/images/sermon/')
	base = os.path.basename(image)
	shutil.copyfile(image, copy_path + base)

# copy worship entries to new site
for entry in worship_posts:
	copy_path = (home + '/Sites/hugo_fbcmuncie/content/worship/')
	base = os.path.basename(entry)
	shutil.copyfile(entry, copy_path + base)

# copy blog posts to new site
for name in blog_posts:
	post = frontmatter.load(name)
	author = field('author')
	title = field('title')
	date = field('date')
	if date:
		datestring = date.strftime('%Y-%m-%d')
		description = post.content
		title_sliced = title.split()
		slug = ("-".join(title_sliced).lower())
		slug = slug.replace("?", "")
		slug = slug.replace("'", "")
		slug = slug.replace(":", "")
		slug = re.sub("[\(\[].*?[\)\]]", "", slug)
		filename =(home + '/Sites/hugo_fbcmuncie/content/blog/' + datestring + '-' + slug + '.md')
		filename = filename.replace("-.", ".")
		filename = filename.replace("--", "-")
		filename = filename.replace(":", "-")
		target = open (filename, 'w')
		target.write('---\n')
		target.write(f'author: "{speaker}"\n')
		target.write(f'title: "{title}"\n')
		target.write(f'date: {date}\n')
		target.write('---\n')
		target.write('\n')
		target.write(description)
		target.write("\n")
		target.close()


